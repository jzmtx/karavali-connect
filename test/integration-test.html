<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karavali Connect - Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .pass { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .fail { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        #results { margin-top: 20px; }
        .log { font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒŠ Karavali Connect - Integration Test Suite</h1>
        
        <div class="test-section info">
            <h3>ğŸ“‹ Test Overview</h3>
            <p>This integration test verifies all major functionalities work correctly after bug fixes.</p>
            <button class="btn-primary" onclick="runAllTests()">ğŸš€ Run All Tests</button>
            <button class="btn-success" onclick="runQuickTest()">âš¡ Quick Test</button>
        </div>

        <div id="results"></div>

        <div class="test-section">
            <h3>ğŸ”§ Manual Test Checklist</h3>
            <div id="manual-tests">
                <label><input type="checkbox"> User Registration & Login</label><br>
                <label><input type="checkbox"> QR Code Generation (Municipality)</label><br>
                <label><input type="checkbox"> Bin QR Scanning (User)</label><br>
                <label><input type="checkbox"> Merchant QR Scanning</label><br>
                <label><input type="checkbox"> Payment Request Flow</label><br>
                <label><input type="checkbox"> Beach Cleanup Process</label><br>
                <label><input type="checkbox"> Safety Reporting</label><br>
                <label><input type="checkbox"> Admin Panel Functions</label><br>
                <label><input type="checkbox"> Real-time Updates</label><br>
                <label><input type="checkbox"> Memory Usage (Multiple Images)</label><br>
            </div>
        </div>
    </div>

    <script>
        let testResults = { passed: 0, failed: 0, logs: [] };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testResults.logs.push({ message: logEntry, type });
            updateResults();
        }

        function assert(condition, message) {
            if (condition) {
                testResults.passed++;
                log(`âœ… ${message}`, 'pass');
            } else {
                testResults.failed++;
                log(`âŒ ${message}`, 'fail');
            }
        }

        // Test 1: Component Loading
        function testComponentLoading() {
            log('Testing Component Loading...', 'test');
            
            // Test if basic JavaScript works
            assert(typeof window !== 'undefined', 'Window object available');
            assert(typeof document !== 'undefined', 'Document object available');
            assert(typeof JSON !== 'undefined', 'JSON object available');
            assert(typeof localStorage !== 'undefined', 'LocalStorage available');
        }

        // Test 2: QR Code Functionality
        function testQRCodeFunctionality() {
            log('Testing QR Code Functionality...', 'test');
            
            // Mock QR data
            const qrData = {
                userId: 'test-user-123',
                secret: 'secret-' + Date.now(),
                timestamp: Date.now()
            };
            
            const qrString = JSON.stringify(qrData);
            const parsed = JSON.parse(qrString);
            
            assert(parsed.userId === qrData.userId, 'QR Code serialization works');
            assert(parsed.timestamp > 0, 'QR Code timestamp valid');
            
            // Test expiration
            const expiredQR = { ...qrData, timestamp: Date.now() - 60000 };
            const age = Date.now() - expiredQR.timestamp;
            assert(age > 45000, 'QR Code expiration logic correct');
        }

        // Test 3: GPS Calculations
        function testGPSCalculations() {
            log('Testing GPS Calculations...', 'test');
            
            const getDistance = (lat1, lng1, lat2, lng2) => {
                const R = 6371e3;
                const Ï†1 = (lat1 * Math.PI) / 180;
                const Ï†2 = (lat2 * Math.PI) / 180;
                const Î”Ï† = ((lat2 - lat1) * Math.PI) / 180;
                const Î”Î» = ((lng2 - lng1) * Math.PI) / 180;

                const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                          Math.cos(Ï†1) * Math.cos(Ï†2) *
                          Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                return Math.round(R * c * 100) / 100;
            };
            
            const dist1 = getDistance(12.9716, 77.5946, 12.9716, 77.5946);
            assert(dist1 === 0, 'Same location distance is 0');
            
            const dist2 = getDistance(12.9716, 77.5946, 12.9717, 77.5947);
            assert(typeof dist2 === 'number' && !isNaN(dist2), 'Distance calculation returns valid number');
        }

        // Test 4: Local Storage
        function testLocalStorage() {
            log('Testing Local Storage...', 'test');
            
            const testKey = 'karavali_test';
            const testData = { user: 'test', timestamp: Date.now() };
            
            try {
                localStorage.setItem(testKey, JSON.stringify(testData));
                const retrieved = JSON.parse(localStorage.getItem(testKey));
                
                assert(retrieved.user === testData.user, 'LocalStorage save/load works');
                
                localStorage.removeItem(testKey);
                assert(localStorage.getItem(testKey) === null, 'LocalStorage cleanup works');
            } catch (error) {
                assert(false, `LocalStorage error: ${error.message}`);
            }
        }

        // Test 5: Date/Time Handling
        function testDateTimeHandling() {
            log('Testing Date/Time Handling...', 'test');
            
            const now = new Date();
            const utcDate = new Date();
            utcDate.setUTCHours(0, 0, 0, 0);
            
            assert(now instanceof Date, 'Date object creation works');
            assert(utcDate.toISOString().includes('T00:00:00.000Z'), 'UTC date formatting correct');
            
            const timestamp = Date.now();
            assert(typeof timestamp === 'number', 'Timestamp generation works');
        }

        // Test 6: Error Handling
        function testErrorHandling() {
            log('Testing Error Handling...', 'test');
            
            try {
                JSON.parse('invalid json');
                assert(false, 'Should have thrown error');
            } catch (error) {
                assert(error instanceof SyntaxError, 'JSON error handling works');
            }
            
            const errorHandler = (code) => {
                switch(code) {
                    case 1: return 'Permission denied';
                    case 2: return 'Unavailable';
                    case 3: return 'Timeout';
                    default: return 'Unknown error';
                }
            };
            
            assert(errorHandler(1) === 'Permission denied', 'Error code handling works');
        }

        // Test 7: Form Validation
        function testFormValidation() {
            log('Testing Form Validation...', 'test');
            
            const validatePhone = (phone) => {
                return phone && phone.startsWith('+91') && phone.length >= 13;
            };
            
            const validateCoins = (coins, max) => {
                const num = parseInt(coins);
                return !isNaN(num) && num > 0 && num <= max;
            };
            
            assert(validatePhone('+91 9876543210'), 'Phone validation works');
            assert(!validatePhone('invalid'), 'Phone validation rejects invalid');
            assert(validateCoins('50', 100), 'Coin validation works');
            assert(!validateCoins('150', 100), 'Coin validation rejects excessive');
        }

        // Test 8: Memory Management
        function testMemoryManagement() {
            log('Testing Memory Management...', 'test');
            
            // Test blob URL creation and cleanup
            const blob = new Blob(['test'], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            assert(url.startsWith('blob:'), 'Blob URL creation works');
            
            URL.revokeObjectURL(url);
            assert(true, 'Blob URL cleanup successful');
            
            // Test timer management
            const timer = setTimeout(() => {}, 1000);
            clearTimeout(timer);
            assert(true, 'Timer cleanup works');
        }

        function runQuickTest() {
            testResults = { passed: 0, failed: 0, logs: [] };
            log('ğŸš€ Starting Quick Test Suite...', 'info');
            
            testComponentLoading();
            testQRCodeFunctionality();
            testLocalStorage();
            
            showFinalResults();
        }

        function runAllTests() {
            testResults = { passed: 0, failed: 0, logs: [] };
            log('ğŸš€ Starting Full Integration Test Suite...', 'info');
            
            const tests = [
                testComponentLoading,
                testQRCodeFunctionality,
                testGPSCalculations,
                testLocalStorage,
                testDateTimeHandling,
                testErrorHandling,
                testFormValidation,
                testMemoryManagement
            ];
            
            tests.forEach((test, index) => {
                setTimeout(() => {
                    test();
                    if (index === tests.length - 1) {
                        setTimeout(showFinalResults, 100);
                    }
                }, index * 200);
            });
        }

        function showFinalResults() {
            log('='.repeat(50), 'info');
            log(`ğŸ“Š Final Results: ${testResults.passed} passed, ${testResults.failed} failed`, 'info');
            
            if (testResults.failed === 0) {
                log('ğŸ‰ All tests passed! Application is ready for deployment.', 'success');
            } else {
                log('âš ï¸ Some tests failed. Please review before deployment.', 'warning');
            }
        }

        function updateResults() {
            const resultsDiv = document.getElementById('results');
            let html = '<h3>ğŸ“Š Test Results</h3>';
            
            testResults.logs.forEach(log => {
                const className = log.type === 'pass' ? 'pass' : 
                                log.type === 'fail' ? 'fail' : 'info';
                html += `<div class="log ${className}">${log.message}</div>`;
            });
            
            if (testResults.passed > 0 || testResults.failed > 0) {
                html += `<div class="test-section ${testResults.failed === 0 ? 'pass' : 'fail'}">`;
                html += `<strong>Summary: ${testResults.passed} passed, ${testResults.failed} failed</strong>`;
                html += '</div>';
            }
            
            resultsDiv.innerHTML = html;
        }

        // Auto-run quick test on page load
        window.onload = () => {
            log('ğŸŒŠ Karavali Connect Integration Test Ready', 'info');
            log('Click "Run All Tests" to verify all functionalities', 'info');
        };
    </script>
</body>
</html>