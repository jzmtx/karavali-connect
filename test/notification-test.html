<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification System Test - Karavali Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-card.success {
            border-color: #10b981;
            background-color: #f0fdf4;
        }

        .test-card.error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        .log-entry {
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        .log-info {
            background-color: #dbeafe;
        }

        .log-success {
            background-color: #d1fae5;
        }

        .log-error {
            background-color: #fee2e2;
        }

        .log-warning {
            background-color: #fef3c7;
        }
    </style>
</head>

<body class="bg-gray-50 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">üîî Notification System Test</h1>
        <p class="text-gray-600 mb-8">Comprehensive testing utility for Karavali Connect notifications</p>

        <!-- Test 1: Browser Support -->
        <div id="test-browser" class="test-card">
            <h3 class="text-xl font-semibold mb-3">1Ô∏è‚É£ Browser Support Check</h3>
            <button onclick="testBrowserSupport()"
                class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 mb-3">
                Run Test
            </button>
            <div id="browser-log" class="mt-3"></div>
        </div>

        <!-- Test 2: Notification Permission -->
        <div id="test-permission" class="test-card">
            <h3 class="text-xl font-semibold mb-3">2Ô∏è‚É£ Notification Permission</h3>
            <button onclick="testPermission()"
                class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 mb-3">
                Request Permission
            </button>
            <div id="permission-log" class="mt-3"></div>
        </div>

        <!-- Test 3: Service Worker -->
        <div id="test-sw" class="test-card">
            <h3 class="text-xl font-semibold mb-3">3Ô∏è‚É£ Service Worker Registration</h3>
            <button onclick="testServiceWorker()"
                class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 mb-3">
                Check Service Worker
            </button>
            <div id="sw-log" class="mt-3"></div>
        </div>

        <!-- Test 4: Browser Notification -->
        <div id="test-notification" class="test-card">
            <h3 class="text-xl font-semibold mb-3">4Ô∏è‚É£ Browser Notification Test</h3>
            <button onclick="testBrowserNotification()"
                class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 mb-3">
                Send Test Notification
            </button>
            <div id="notification-log" class="mt-3"></div>
        </div>

        <!-- Summary -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-4">Test Summary</h2>
            <div id="summary" class="text-gray-700">Run tests to see summary...</div>
        </div>
    </div>

    <script>
        let testResults = { browser: null, permission: null, serviceWorker: null, notification: null };

        function log(elementId, message, type = 'info') {
            const logDiv = document.getElementById(elementId);
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateTestStatus(testId, status) {
            const element = document.getElementById(testId);
            element.classList.remove('success', 'error');
            if (status) element.classList.add(status);
        }

        async function testBrowserSupport() {
            log('browser-log', 'Checking browser support...', 'info');

            const checks = {
                'Notification API': 'Notification' in window,
                'Service Worker': 'serviceWorker' in navigator,
                'Push Manager': 'PushManager' in window
            };

            let allPassed = true;
            for (const [feature, supported] of Object.entries(checks)) {
                if (supported) {
                    log('browser-log', `‚úÖ ${feature}: Supported`, 'success');
                } else {
                    log('browser-log', `‚ùå ${feature}: Not Supported`, 'error');
                    allPassed = false;
                }
            }

            testResults.browser = allPassed;
            updateTestStatus('test-browser', allPassed ? 'success' : 'error');
            updateSummary();
        }

        async function testPermission() {
            log('permission-log', 'Requesting notification permission...', 'info');

            try {
                const permission = await Notification.requestPermission();
                log('permission-log', `Permission status: ${permission}`, permission === 'granted' ? 'success' : 'warning');

                testResults.permission = permission === 'granted';
                updateTestStatus('test-permission', permission === 'granted' ? 'success' : 'error');
                updateSummary();
            } catch (error) {
                log('permission-log', `Error: ${error.message}`, 'error');
                testResults.permission = false;
                updateTestStatus('test-permission', 'error');
            }
        }

        async function testServiceWorker() {
            log('sw-log', 'Checking service worker...', 'info');

            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                log('sw-log', `Found ${registrations.length} service worker(s)`, 'info');

                for (const reg of registrations) {
                    log('sw-log', `SW Scope: ${reg.scope}`, 'info');
                    log('sw-log', `SW State: ${reg.active?.state || 'not active'}`, 'info');
                }

                if (registrations.length === 0) {
                    log('sw-log', 'Attempting to register service worker...', 'info');
                    const reg = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                    log('sw-log', `Service worker registered: ${reg.scope}`, 'success');
                }

                testResults.serviceWorker = registrations.length > 0 || true;
                updateTestStatus('test-sw', 'success');
                updateSummary();
            } catch (error) {
                log('sw-log', `Error: ${error.message}`, 'error');
                testResults.serviceWorker = false;
                updateTestStatus('test-sw', 'error');
            }
        }

        async function testBrowserNotification() {
            log('notification-log', 'Sending test notification...', 'info');

            try {
                if (Notification.permission !== 'granted') {
                    log('notification-log', 'Permission not granted. Request permission first.', 'warning');
                    return;
                }

                const notification = new Notification('üîî Test Notification', {
                    body: 'This is a test notification from Karavali Connect',
                    icon: '/icon-192x192.png',
                    tag: 'test',
                    requireInteraction: false
                });

                notification.onclick = () => {
                    log('notification-log', 'Notification clicked!', 'success');
                    notification.close();
                };

                log('notification-log', '‚úÖ Notification sent successfully', 'success');
                testResults.notification = true;
                updateTestStatus('test-notification', 'success');
                updateSummary();
            } catch (error) {
                log('notification-log', `Error: ${error.message}`, 'error');
                testResults.notification = false;
                updateTestStatus('test-notification', 'error');
            }
        }

        function updateSummary() {
            const passed = Object.values(testResults).filter(r => r === true).length;
            const failed = Object.values(testResults).filter(r => r === false).length;
            const total = Object.values(testResults).filter(r => r !== null).length;

            const summaryHtml = `
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="bg-green-100 p-4 rounded">
                        <div class="text-2xl font-bold text-green-800">${passed}</div>
                        <div class="text-sm text-green-600">Passed</div>
                    </div>
                    <div class="bg-red-100 p-4 rounded">
                        <div class="text-2xl font-bold text-red-800">${failed}</div>
                        <div class="text-sm text-red-600">Failed</div>
                    </div>
                    <div class="bg-blue-100 p-4 rounded">
                        <div class="text-2xl font-bold text-blue-800">${total}</div>
                        <div class="text-sm text-blue-600">Total</div>
                    </div>
                </div>
                <div class="text-sm">
                    <h3 class="font-semibold mb-2">Test Results:</h3>
                    <ul class="space-y-1">
                        <li>Browser Support: ${getStatusIcon(testResults.browser)}</li>
                        <li>Permission: ${getStatusIcon(testResults.permission)}</li>
                        <li>Service Worker: ${getStatusIcon(testResults.serviceWorker)}</li>
                        <li>Browser Notification: ${getStatusIcon(testResults.notification)}</li>
                    </ul>
                </div>
            `;

            document.getElementById('summary').innerHTML = summaryHtml;
        }

        function getStatusIcon(status) {
            if (status === true) return '‚úÖ Passed';
            if (status === false) return '‚ùå Failed';
            return '‚è∏Ô∏è Not Run';
        }

        // Auto-run browser support test on load
        window.addEventListener('load', () => {
            setTimeout(() => testBrowserSupport(), 500);
        });
    </script>
</body>

</html>